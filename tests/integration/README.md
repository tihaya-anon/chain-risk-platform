# Integration Tests

This directory contains integration tests for the Chain Risk Platform data pipeline.

## Overview

The integration test validates the complete data flow:

```
Mock Etherscan Server (local) → data-ingestion (local) → Kafka (remote) → stream-processor (local) → PostgreSQL (remote)
```

**Note**: The test runs services locally but connects to infrastructure (Kafka, PostgreSQL, etc.) on a remote Docker host.

## Quick Start

```bash
# From project root
make test-integration
```

## Test Fixtures

The mock server can serve data from two sources:

### 1. Real API Fixtures (Recommended)

Generate fixtures from real Etherscan API responses:

```bash
# Set your API key
export ETHERSCAN_API_KEY=your_api_key

# Generate fixtures (fetches latest 3 blocks)
make fixture-gen

# Or manually with more options
cd data-ingestion
go run ./cmd/fixture-gen \
  -network ethereum \
  -blocks 19000000,19000001,19000002 \
  -output ../tests/integration/fixtures
```

### 2. Generated Mock Data (Fallback)

If no fixtures are available, the mock server generates deterministic test data.

## Running the Mock Server

```bash
# With fixtures (recommended)
make mock-server-run

# Or manually
cd tests/integration/mock_server
./bin/mock_server -fixtures ../fixtures/ethereum -port 8545

# Without fixtures (fallback mode)
./bin/mock_server -fallback=true -start-block 1000 -num-blocks 10
```

## Environment Configuration

The test automatically reads configuration from:

1. **`.env.local`** - Contains `DOCKER_HOST_IP` (your remote Docker server IP)
2. **`scripts/env-remote.sh`** - Sets up all service connection URLs

Example `.env.local`:
```bash
DOCKER_HOST_IP=100.120.144.128
ETHERSCAN_API_KEY=your-api-key
```

### Remote Docker Ports

| Service    | Port  |
| ---------- | ----- |
| PostgreSQL | 15432 |
| Redis      | 16379 |
| Kafka      | 19092 |
| Neo4j HTTP | 17474 |
| Neo4j Bolt | 17687 |
| Nacos      | 18848 |

## Directory Structure

```
tests/integration/
├── mock_server/          # Mock Etherscan API server
│   ├── main.go           # Server that loads fixtures
│   ├── go.mod
│   └── bin/              # Built binary (gitignored)
├── fixtures/             # Test data fixtures
│   ├── README.md         # Fixture documentation
│   └── ethereum/         # Ethereum network fixtures
│       ├── manifest.json # Index of all fixtures
│       ├── blocks/       # Block data by number
│       ├── addresses/    # Address transaction data
│       └── internal_txs/ # Internal transactions
└── README.md

data-ingestion/
└── cmd/
    └── fixture-gen/      # Tool to generate fixtures from real API
        ├── main.go
        └── fetcher.go

scripts/
├── run_integration_test.sh  # Main integration test script
├── run-flink.sh             # Flink runner (used by integration test)
├── env-remote.sh            # Environment setup
└── check-infra.sh           # Infrastructure health check
```

## Components

### Fixture Generator (`data-ingestion/cmd/fixture-gen/`)

A tool to fetch real blockchain API responses and save them as test fixtures.

**Usage:**
```bash
# Fetch specific blocks
fixture-gen -network ethereum -blocks 19000000,19000001

# Fetch latest N blocks
fixture-gen -network ethereum -latest 5

# Fetch address transactions
fixture-gen -network ethereum \
  -address 0xdAC17F958D2ee523a2206206994597C13D831ec7 \
  -start-block 19000000 -end-block 19000100

# Skip internal transactions (faster)
fixture-gen -network ethereum -blocks 19000000 -internal-txs=false
```

### Mock Etherscan Server (`mock_server/`)

A Go HTTP server that serves fixture data or generates mock data.

**Features:**
- Loads fixtures from disk (generated by fixture-gen)
- Falls back to generated data when fixtures not available
- Provides `/health` and `/status` endpoints
- Indexes internal transactions for quick lookup

**Build:**
```bash
make mock-server-build
```

**Manual Run:**
```bash
cd tests/integration/mock_server

# With fixtures
./bin/mock_server -fixtures ../fixtures/ethereum -port 8545

# Fallback mode only
./bin/mock_server -fallback=true -start-block 1000 -num-blocks 10
```

**Parameters:**
- `-port`: HTTP server port (default: 8545)
- `-fixtures`: Path to fixtures directory (default: ../fixtures/ethereum)
- `-fallback`: Fall back to generated data if fixture not found (default: true)
- `-start-block`: Starting block for generated data (default: 1000)
- `-num-blocks`: Number of blocks for generated data (default: 10)

**Endpoints:**
- `GET /api?module=proxy&action=eth_blockNumber` - Latest block number
- `GET /api?module=proxy&action=eth_getBlockByNumber&tag=0x...` - Block by number
- `GET /api?module=account&action=txlistinternal&txhash=0x...` - Internal txs
- `GET /api?module=account&action=txlist&address=0x...` - Address txs
- `GET /health` - Health check
- `GET /status` - Server status with loaded fixtures info

### Integration Test Script (`scripts/run_integration_test.sh`)

Main integration test script that:
1. Sources environment from `.env.local` and `env-remote.sh`
2. Checks prerequisites (Go, Java, Maven, psql, remote connections)
3. Clears existing test data from PostgreSQL
4. Starts the Mock Etherscan Server (locally)
5. Runs data-ingestion service pointing to mock server
6. Runs Flink stream-processor via `run-flink.sh`
7. Verifies data in PostgreSQL
8. Prints sample data for inspection

## Prerequisites

1. **Remote Docker containers running:**
   ```bash
   make ensure-infra
   ```

2. **Go 1.21+ installed**

3. **Java 17+ and Maven installed** (for Flink)

4. **PostgreSQL client (psql) installed**
   ```bash
   # macOS
   brew install postgresql
   ```

5. **netcat (nc) installed** (for Kafka connectivity check)

## Running Tests

### Full Integration Test (Recommended)

```bash
make test-integration
```

### Check Infrastructure First

```bash
make ensure-infra
```

### Manual Testing

1. **Generate fixtures (optional but recommended):**
   ```bash
   export ETHERSCAN_API_KEY=your_api_key
   make fixture-gen
   ```

2. **Source environment:**
   ```bash
   source .env.local
   source scripts/env-remote.sh
   ```

3. **Start Mock Server:**
   ```bash
   make mock-server-run
   # Or without fixtures:
   # cd tests/integration/mock_server && ./bin/mock_server -fallback=true
   ```

4. **Run data-ingestion:**
   ```bash
   cd data-ingestion
   ETHERSCAN_BASE_URL="http://localhost:8545/api?" \
   ETHERSCAN_API_KEY="test" \
   go run ./cmd/ingestion
   ```

5. **Run stream-processor:**
   ```bash
   make run-flink
   ```

6. **Verify data:**
   ```bash
   PGPASSWORD=chainrisk123 psql -h $POSTGRES_HOST -p $POSTGRES_PORT -U chainrisk -d chainrisk -c \
     "SELECT COUNT(*) FROM chain_data.transfers"
   ```

## Expected Results

For 10 blocks with ~3 transactions each:
- **Transfers:** ~30 records (native + ERC20)
- **Transactions:** ~30 records
- **Processing State:** 1 record per network

## Troubleshooting

### Cannot Connect to Remote Docker

```bash
# Check if DOCKER_HOST_IP is set correctly
echo $DOCKER_HOST_IP

# Test connectivity
ping $DOCKER_HOST_IP

# Check all services
make ensure-infra
```

### Kafka Connection Issues
```bash
# Check Kafka is accessible
nc -z $DOCKER_HOST_IP 19092

# Check topic exists (if kcat installed)
kcat -b $DOCKER_HOST_IP:19092 -L
```

### PostgreSQL Connection Issues
```bash
# Test connection
PGPASSWORD=chainrisk123 psql -h $POSTGRES_HOST -p $POSTGRES_PORT -U chainrisk -d chainrisk -c "SELECT 1"

# Check schema exists
PGPASSWORD=chainrisk123 psql -h $POSTGRES_HOST -p $POSTGRES_PORT -U chainrisk -d chainrisk -c "\dt chain_data.*"
```

### No Data in Database
1. Check Kafka messages (if kcat installed):
   ```bash
   kcat -b $DOCKER_HOST_IP:19092 -t chain-transactions -C -c 5
   ```

2. Check Flink logs for errors

3. Verify mock server is returning data:
   ```bash
   curl "http://localhost:8545/api?module=proxy&action=eth_blockNumber"
   ```

4. Check mock server status:
   ```bash
   curl "http://localhost:8545/status"
   ```

### Schema Not Found
If `chain_data` schema doesn't exist, run the init script:
```bash
PGPASSWORD=chainrisk123 psql -h $POSTGRES_HOST -p $POSTGRES_PORT -U chainrisk -d chainrisk -f infra/postgres/init.sql
```
